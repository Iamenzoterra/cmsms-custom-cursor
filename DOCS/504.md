# 504 Gateway Timeout on Merlin Wizard Content Import

**Status:** RESOLVED — Fixed via `should_register_controls()` guard in module.php
**Severity:** HIGH (blocks first-time theme setup)
**Environment:** helga-testing.cmsmasters.studio/neotesto
**Theme:** Pixel Craft
**Date discovered:** 2026-02-13

---

## Symptom

First-time Merlin wizard run: after `step=plugins` (install/update plugins), the redirect to `step=content` returns **504 Gateway Time-out** (nginx). Page hangs and shows nginx error page.

**Critical fact:** Second run works fine. Re-entering the dashboard and running the wizard again completes without timeout. The 504 only happens on the **first** activation after plugin changes.

---

## Reproduction Steps

1. Navigate to `wp-admin/themes.php?page=merlin&step=license`
2. Click "Activate" (license step passes)
3. Click "One-click Install" on demo (Pixel Craft Demo)
4. Wizard proceeds to `step=plugins` (installs/updates plugins)
5. After plugins install, wizard redirects to `step=content`
6. **504 Gateway Time-out** on `step=content` page load

### Why second run succeeds

After the 504, going back to the dashboard and re-running:
- Plugins are already installed (step=plugins is a no-op)
- Elementor CSS cache was already regenerated during the failed first request (or partially)
- Control stacks are cached from the first run
- No heavy CSS regeneration needed = fast page load

---

## Root Cause Analysis

### The chain of events

```
step=plugins
  └─ Installs/updates plugins (Elementor, CMSMasters addon, etc.)
  └─ Elementor detects plugin changes → invalidates CSS cache
       │
step=content  (FIRST admin page load after plugin changes)
  └─ WordPress loads admin page
  └─ Elementor hooks fire → CSS regeneration triggered
  └─ CSS regen builds control stacks for ALL element types
       │
       ├─ For each element type (section, container, column, widget):
       │   └─ Fires elementor/element/{type}/_section_responsive/after_section_end
       │   └─ Our register_controls() adds ~50 cursor controls
       │
       ├─ For each Document type:
       │   └─ Fires elementor/element/after_section_end
       │   └─ Our register_page_cursor_controls() adds ~7 cursor controls
       │
       └─ Total: hundreds of control registrations across all element types
           └─ PHP execution time exceeds nginx proxy_read_timeout → 504
```

### Why our code is the bottleneck

1. **`init_actions()` registers control hooks unconditionally** (line 18-28 in module.php)
   - These hooks fire during CSS regeneration on ANY admin page
   - `register_controls()` is called for every element type during control stack building
   - `register_page_cursor_controls()` fires via `elementor/element/after_section_end` for every section of every element

2. **`init_filters()` has `is_admin()` guard** (line 30-36) — but this only protects `before_render` hooks
   - `before_render` hooks are NOT the problem
   - Control registration hooks in `init_actions()` have NO guard

3. **`WP_IMPORTING` guard exists** (line 47) — but doesn't help
   - Merlin wizard `step=content` is NOT an import context yet at the page load
   - `WP_IMPORTING` is only defined during actual content import (XML processing)
   - The 504 happens BEFORE content import starts — it's the page load itself

### The is_admin() asymmetry

```
init_filters()  → guarded by is_admin()  ← before_render hooks skip on admin pages
init_actions()  → NO guard               ← control hooks fire on ALL admin pages
                                              including during CSS regeneration
```

---

## Previous Mitigation Attempts

### Attempt 1: `WP_IMPORTING` guard in `register_controls()` (already in code)

```php
// module.php line 47
if ( defined( 'WP_IMPORTING' ) && WP_IMPORTING ) {
    return;
}
```

**Result:** Does NOT prevent 504. `WP_IMPORTING` is not defined during the `step=content` page load — it's only set during actual XML content import. The timeout happens on the page load before any import starts.

### Attempt 2: `WP_IMPORTING` guard in `register_page_cursor_controls()` (already in code)

```php
// module.php line 878
if ( defined( 'WP_IMPORTING' ) && WP_IMPORTING ) {
    return;
}
```

**Result:** Same issue — guard doesn't trigger during the problematic page load.

### Attempt 3: `is_admin()` guard in `init_filters()` (already in code)

```php
// module.php line 34
if ( is_admin() ) {
    return;
}
```

**Result:** Only blocks `before_render` hooks. Control registration hooks in `init_actions()` remain unguarded and fire during CSS regeneration.

---

## Applied Fix

Added `should_register_controls()` private method that checks `is_admin()`, `wp_doing_ajax()`, and `$_REQUEST['action'] === 'elementor'`. This guard is called at the top of both `register_controls()` and `register_page_cursor_controls()`.

```php
private function should_register_controls() {
    if ( ! is_admin() ) {
        return true;  // Frontend — always allow
    }
    if ( wp_doing_ajax() ) {
        return true;  // AJAX — editor save, kit operations
    }
    // Admin page — only register if it's the Elementor editor (?action=elementor)
    return ! empty( $_REQUEST['action'] ) && 'elementor' === $_REQUEST['action'];
}
```

### Why `$_REQUEST['action']` and not `is_edit_mode()`

`is_edit_mode()` depends on `Editor->is_edit_mode` property which is set AFTER control stacks are built. Using it would return `false` even in the editor, breaking the panel. `$_REQUEST['action']` is available from the first line of PHP — same check Elementor uses internally, but without timing dependency.

### Decision table

| Context | is_admin | wp_doing_ajax | $_REQUEST['action'] | Result |
|---------|----------|---------------|---------------------|--------|
| Merlin step=content | true | false | 'merlin' | **SKIP** |
| CSS regen (page load) | true | false | - | **SKIP** |
| Editor page | true | false | 'elementor' | REGISTER |
| AJAX (editor save) | true | true | - | REGISTER |
| Frontend | false | false | - | REGISTER |
| WP-Cron | true | false | - | **SKIP** |

---

## Network Evidence

Captured during live reproduction on 2026-02-13:

| Request | Status | Note |
|---------|--------|------|
| `step=plugins` | 200 | Plugins installed OK |
| `step=content` | **504** | First admin page after plugin install |
| `step=content` (retry) | 200 | Second attempt works |

The 504 is on a full page navigation (not AJAX). The browser receives `504 Gateway Time-out` from nginx, meaning PHP-FPM exceeded the proxy timeout.

---

## Related Issues

- **DEPLOY-001** (resolved): `frontend.php` breaking widgets — our PHP modifications caused dependency issues
- **PERF-001** (deferred): RAF always running — performance concern but unrelated to server-side
- **init_filters() guard**: Already has `is_admin()` protection — pattern to follow for `init_actions()`

---

## Files Involved

| File | Role | Current Guard |
|------|------|---------------|
| `modules/cursor-controls/module.php:18-28` | `init_actions()` — registers control hooks | **NONE** |
| `modules/cursor-controls/module.php:30-43` | `init_filters()` — registers render hooks | `is_admin()` |
| `modules/cursor-controls/module.php:45-49` | `register_controls()` | `WP_IMPORTING` (insufficient) |
| `modules/cursor-controls/module.php:862-880` | `register_page_cursor_controls()` | `WP_IMPORTING` (insufficient) |

---

## Key Insight

Elementor CSS regeneration is triggered by plugin install/update. During regen, Elementor builds the full control stack for every element type — which means our `register_controls()` hook fires hundreds of times. This is unnecessary because:

1. CSS regeneration doesn't use our controls (we don't output CSS from controls)
2. Our controls only affect data attributes on the frontend DOM
3. Controls are only needed in the Elementor editor panel

The fix is to register control hooks **only when the editor is active**, not on every admin page load.
